# Post Release ワークフロー

## 概要

GitHub Releaseが公開された後の自動処理を実行するワークフロー。
NPMパッケージの公開とDockerイメージの作成・公開を自動化。

## トリガー条件

- GitHub Releaseが公開された時（`release.released`）
- 手動リリース作業後の自動実行

## 実行内容

### NPMパッケージ公開ジョブ (npm)

#### 1. 環境セットアップ

- Ubuntu環境で実行
- Node.js 16.17を使用
- NPMレジストリを`https://registry.npmjs.org`に設定

#### 2. リリースタグでのチェックアウト

- 公開されたリリースタグを指定
- 確実にリリース版のコードを使用
- `${{ github.event.release.tag_name }}`で動的に取得

#### 3. 依存関係管理

- Immutableモードでの厳密なインストール
- ロックファイルの整合性確保
- Corepackによる高速化

#### 4. NPMパッケージ公開

- `packages/suite`ディレクトリのパッケージを公開
- 自動バージョン管理
- `NODE_AUTH_TOKEN`でのNPM認証

### Dockerイメージ公開ジョブ (docker)

#### 1. 環境セットアップ

- Ubuntu環境で実行
- Docker Buildx使用
- マルチアーキテクチャ対応

#### 2. レジストリ認証

- GitHub Container Registry (ghcr.io)
- 実行者アカウントでの認証
- `packages: write`権限が必要

#### 3. バージョン処理

- リリースタグから`v`プレフィックスを除去
- 例: `v1.2.3` → `1.2.3`
- Docker tagの標準形式に準拠

#### 4. イメージビルド・公開

- マルチタグでの公開
  - `latest`: 最新版タグ
  - `{version}`: 具体的なバージョンタグ
- 自動的なイメージプッシュ

## 必要な設定

### シークレット

- `NPM_PUBLISH_TOKEN`: NPMパッケージ公開権限
- `GITHUB_TOKEN`: GitHub Container Registry権限（自動提供）

### 権限

- **NPMジョブ**: 特別な権限不要
- **Dockerジョブ**:
  - `contents: read`: リポジトリ読み取り
  - `packages: write`: コンテナレジストリ書き込み

## 成果物

### NPMパッケージ

- パッケージ名: `@lichtblick/suite`
- 公開レジストリ: npmjs.org
- 自動バージョン管理

### Dockerイメージ

- レジストリ: `ghcr.io`
- イメージ名: `ghcr.io/{owner}/{repo}`
- タグ: `latest`, `{version}`

## 動作フロー

### 1. リリース公開

1. 手動またはリリースワークフローでGitHub Releaseを作成
2. `released`イベントが発生
3. 本ワークフローが自動実行

### 2. 並行処理

- NPMパッケージ公開とDockerイメージ作成を並行実行
- 独立したジョブで高速処理
- 一方の失敗が他方に影響しない

### 3. 成果物配信

- NPM: パッケージマネージャー経由でのインストール
- Docker: コンテナ環境での実行

## 注意点

- **タグ確認**: リリースタグが正しく設定されているか確認
- **権限管理**: NPMトークンの有効期限とスコープ確認
- **失敗時対応**: 手動での再実行が必要
- **バージョン競合**: 既存バージョンとの競合回避

## 運用上の利点

- **自動化**: 手動作業の削減
- **一貫性**: 常に同じ手順での公開
- **高速化**: 並行処理による時間短縮
- **トレーサビリティ**: リリースタグとの確実な紐付け

## 制限事項

- リリース後の自動実行のみ
- 失敗時の自動リトライなし
- バージョン重複時のエラー
- 手動でのロールバック不可

## トラブルシューティング

- NPMトークンの権限確認
- Docker BuildxとGHCRの接続確認
- リリースタグの形式確認
- 依存関係の整合性確認

## 最適化提案

- 失敗時の自動リトライ機能
- 成功・失敗の通知機能
- バージョン競合時の自動対応
- ロールバック機能の追加
