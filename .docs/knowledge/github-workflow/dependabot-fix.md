# Dependabot Fix ワークフロー

## 概要

Dependabotが作成したプルリクエストの自動修正を行うワークフロー。
依存関係の重複解決とPRの自動承認を実行し、依存関係更新の手間を削減。

## セキュリティ重要事項

⚠️ **セキュリティ上重要**: `pull_request_target`イベントを使用
信頼されたコンテキストで実行されるため、スクリプト実行は無効化

## トリガー条件

- `pull_request_target`イベント
- Dependabotによる自動PR作成時のみ実行
- 条件: `github.actor == 'dependabot[bot]'`

## 実行内容

### 1. セキュリティ対策

- **重要**: `YARN_ENABLE_SCRIPTS=false`でスクリプト実行を無効化
- 信頼されないPRコードの実行を防止
- pwn request攻撃の防止

### 2. 環境セットアップ

- Ubuntu環境で実行
- Node.js 16.17を使用
- Yarnパッケージマネージャー有効化

### 3. 依存関係修正

- `yarn install --mode skip-build`で高速インストール
- `YARN_ENABLE_IMMUTABLE_INSTALLS=false`で更新許可
- `yarn dedupe`で重複依存関係の解決

### 4. 自動コミット

- Dependabotボットとして設定
- 修正内容をコミット（`[dependabot skip] Fix yarn.lock`）
- 変更がない場合も空コミット作成

### 5. 自動承認（新規PRのみ）

- プルリクエストの自動承認
- `opened`または`reopened`イベント時のみ実行
- GitHub API経由での承認処理

### 6. 自動マージ指示

- `@dependabot squash and merge`コメントを追加
- Dependabotに自動マージを指示
- Squash Mergeでの統合

## 必要な設定

### シークレット

- `LICHTBLICK_GITHUB_TOKEN`: GitHub操作権限付きトークン
- デフォルトトークンではワークフロー実行不可

### 権限

- Pull Request読み取り・書き込み権限
- Issue操作権限（コメント投稿）
- レビュー権限

## セキュリティ設計

### 重要な安全対策

1. **スクリプト実行禁止**: `YARN_ENABLE_SCRIPTS=false`
2. **信頼されたコンテキスト**: `pull_request_target`使用
3. **ボット限定**: Dependabotからのみ実行
4. **コード実行回避**: 信頼されないPRコードは実行せず

### 攻撃シナリオ防止

- 悪意のあるnpmパッケージの追加による攻撃を防止
- 信頼されたコンテキストでの任意コード実行を防止
- PWN Request攻撃の防止

## 動作フロー

### 1. PR作成時

1. Dependabotが依存関係更新PRを作成
2. 本ワークフローが自動実行
3. `yarn dedupe`で重複解決
4. 変更をコミット・プッシュ
5. プルリクエストを自動承認
6. 自動マージ指示コメント投稿

### 2. PR更新時

1. Dependabotが既存PRを更新
2. 重複解決のみ実行
3. 自動承認・マージ指示はスキップ

## 注意点

- **セキュリティ**: スクリプト実行の無効化が必須
- **権限**: 専用トークンが必要
- **対象**: Dependabotのみ実行
- **マージ**: 手動確認が必要な場合あり

## 運用上の利点

- **自動化**: 依存関係更新の手間削減
- **高速化**: 手動確認の省略
- **安全性**: セキュリティ対策済み
- **一貫性**: 常に同じ修正処理を適用

## 制限事項

- Major更新は手動確認推奨
- 破壊的変更は自動承認対象外
- 複雑な依存関係問題は手動対応
- セキュリティ更新は個別検証必要

## トラブルシューティング

- yarn.lockの競合解決
- 権限エラーの確認
- Dependabotの動作状況確認
- 自動マージ失敗時の手動対応
