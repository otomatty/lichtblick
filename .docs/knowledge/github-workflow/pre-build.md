# Pre-Build ワークフロー

## 概要

リリース前の事前ビルドを実行し、各プラットフォーム向けのバイナリを生成するワークフロー。
リリース準備の一環として、配布用ファイルを事前に作成し、GitHub Artifactとして保存。

## トリガー条件

- 手動実行のみ（`workflow_dispatch`）
- 通常はAuto Bump Versionワークフローから自動実行
- 緊急時の手動実行も可能

## 実行内容

### 1. 環境セットアップ

- macOS環境で実行（全プラットフォーム対応のため）
- Node.js 16.17を使用
- Yarnパッケージマネージャー有効化

### 2. 依存関係管理

- Immutableモードでの厳密なインストール
- ロックファイルの整合性確保
- 開発・本番両方の依存関係をインストール

### 3. バージョン情報取得

- `package.json`からバージョン情報を読み取り
- 環境変数として設定（`version`）
- アーティファクト名に使用

### 4. デスクトップアプリケーションビルド

- プロダクション環境向けElectronアプリケーション
- 最適化されたバンドルの生成
- 各プラットフォーム向けの準備

### 5. 全プラットフォーム向けパッケージング

#### Windows版

- 実行ファイル形式（.exe）
- インストーラー付き
- x64アーキテクチャ対応

#### Linux版

- Debian パッケージ（.deb）
- AMD64アーキテクチャ
- システムインストール対応

#### macOS版

- DMGイメージファイル
- Universalバイナリ（Intel + Apple Silicon）
- macOSネイティブ対応

### 6. アーティファクト管理

- GitHub Actionsのアーティファクト機能を使用
- 30日間の保存期間設定
- プラットフォーム別の分類

## 必要な設定

### シークレット

- `LICHTBLICK_GITHUB_TOKEN`: リポジトリアクセス権限

### 権限

- Actions実行権限
- アーティファクト作成権限

## 生成されるアーティファクト

### Windows版

- **名前**: `lichtblick-{version}-windows`
- **ファイル**: `lichtblick-{version}-win.exe`
- **形式**: 実行可能インストーラー

### Linux版

- **名前**: `lichtblick-{version}-debian-amd64`
- **ファイル**: `lichtblick-{version}-linux-amd64.deb`
- **形式**: Debianパッケージ

### macOS版

- **名前**: `lichtblick-{version}-macos`
- **ファイル**: `lichtblick-{version}-mac-universal.dmg`
- **形式**: DMGディスクイメージ

## 動作フロー

### 1. 自動実行（通常）

1. Auto Bump Versionワークフローが実行
2. バージョンアップ後にPre-buildワークフローをトリガー
3. 新しいバージョンでビルド実行
4. アーティファクトを保存

### 2. 手動実行（緊急時）

1. GitHub Actionsから手動実行
2. 現在のコードでビルド
3. テスト用または緊急配布用ファイル作成

## 注意点

- **macOS環境必須**: 全プラットフォームビルドのため
- **時間コスト**: 全プラットフォームのビルドで時間が必要
- **容量制限**: GitHub Actionsのアーティファクト容量制限
- **保存期間**: 30日後に自動削除

## 運用上の利点

- **事前準備**: リリース前の配布ファイル準備
- **品質確認**: 事前ビルドでの問題発見
- **高速リリース**: 本リリース時の時間短縮
- **テスト配布**: 内部テスト用の配布

## 制限事項

- GitHub Actionsのマシン性能に依存
- アーティファクト容量制限（総計2GB）
- 30日間の保存期間制限
- macOS環境での実行必須

## 最適化提案

- **並列化**: プラットフォーム別の並列ビルド
- **キャッシュ**: ビルド成果物のキャッシュ活用
- **条件分岐**: 変更されたプラットフォームのみビルド
- **圧縮**: アーティファクトの圧縮による容量削減

## 関連ワークフロー

- **前段階**: Auto Bump Version
- **後段階**: Release
- **連携**: バージョン管理とリリース作業の自動化

## トラブルシューティング

- ビルド失敗時のローカル検証
- プラットフォーム固有の問題確認
- 依存関係の整合性チェック
- アーティファクトのダウンロード確認
