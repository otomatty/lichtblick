# Cloudflare Pages ワークフロー

## 概要

プルリクエスト時にWebアプリケーションをCloudflare Pagesに自動デプロイするワークフロー。
レビュー用プレビュー環境を提供し、実際のWebアプリケーションでの動作確認を可能にする。

## トリガー条件

- 全てのプルリクエスト（作成・更新）
- マージ前の動作確認とレビュー支援

## 実行内容

### 1. 環境セットアップ

- Ubuntu環境で実行
- Node.js 16.17を使用
- Yarnパッケージマネージャー有効化

### 2. 依存関係管理

- Immutableモードでの厳密なインストール
- サブモジュールを含む完全なチェックアウト
- 実験的なCorepack機能を有効化

### 3. Webアプリケーションビルド

- プロダクション環境向けビルド実行
- 静的ファイル生成（`web/.webpack`）
- 最適化されたアセット作成

### 4. Cloudflare対応

- Vercel-Cloudflare互換性対応
- 設定ファイルの配置（`web/.cloudflare/*`）
- デプロイ用ファイル構成の調整

### 5. Cloudflare Pagesデプロイ

- 動的ブランチ名でのデプロイ
- プレビューURLの自動生成
- PRコメントでのURL通知

## 必要な設定

### シークレット

- `CLOUDFLARE_ACCOUNT_ID`: Cloudflareアカウント識別子
- `CLOUDFLARE_API_TOKEN`: Cloudflare API認証トークン
- `LICHTBLICKBOT_GITHUB_TOKEN`: GitHub統合用トークン

### 環境変数

- `ENABLE_EXPERIMENTAL_COREPACK`: 実験的機能の有効化

## 同期制御

### Concurrency設定

- **グループ**: `cloudflare-pages-{ref}`
- **キャンセル**: 同一PRの新しいコミットで前回デプロイをキャンセル無効
- **理由**: 複数のプレビュー環境を同時維持

## デプロイメント詳細

### プロジェクト設定

- **プロジェクト名**: `lichtblick-suite-oss`
- **ソースディレクトリ**: `web/.webpack`
- **ブランチ名**: PR作成ブランチ名またはリファレンス名

### ブランチ戦略

- PRごとに独立したプレビュー環境
- ブランチ名ベースのURL生成
- 自動的なブランチ検出

## 互換性対応

- Vercel設定ファイルのCloudflare対応
- 静的ファイル配信の最適化
- CDN設定の適用

## 注意点

- プルリクエストのみ実行
- プレビュー環境は一時的
- Cloudflare Pagesの制限に依存
- デプロイ失敗時は手動確認必要

## 運用上の利点

- **即座のプレビュー**: コードレビューと同時に動作確認
- **リアルタイム更新**: 新しいコミットで自動再デプロイ
- **共有しやすいURL**: ステークホルダーとの共有が容易
- **本番環境類似**: 実際の配信環境での動作確認

## 制限事項

- 静的サイトのみ対応
- サーバーサイド機能は無効
- Cloudflare Pagesの容量制限適用
- 複雑なAPI統合は制限

## トラブルシューティング

- ビルドエラー時はローカルでの検証必須
- API TokenとAccount IDの権限確認
- Cloudflare Pagesダッシュボードでの状態確認
- プレビューURLのアクセス制御設定
